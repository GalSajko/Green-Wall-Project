<!DOCTYPE html>
<html>
<head>
    <script src="{{ url_for('static', filename='js/jquery-3.6.3.js') }}" type="text/javascript"></script>

</head>
<body>
    <h1>Blue - Green Wall</h1>
    <p class="data"></p>
    <div>
        <canvas id="canvas" width="3000px" height="3000px"></canvas>
    </div>
    <canvas id = "canvas"></canvas>
    <script>
        var brokenSensorLoc = []
        var lastData = []
        var bw = 240
        var bh = 300
        var p = 3
        var pad = 20
        var yDim = 50
        var xDim = 40
        var numPinsY = 13
        var numPinsX = 21
        var start = 20
        var canvas = document.getElementById("canvas");
        var ctx = canvas.getContext("2d");
        function draw(data,lastData,brokenSensorLoc){
            ctx.beginPath()
            for(var j  = 1; j<7; j++){    
                start = 20;
                for(var y = 0; y < 6; y++ ){
                    for(var x = 0;x < 6;x++){
                        try{
                            if(j == 1 || j == 4){
                                start = 60;
                            }
                            else if(j == 3 || j == 6){
                                start = -20;
                            }
                            if(Number(data[j][y][x]) == Number(1)){
                                    ctx.beginPath()
                                    ctx.fillStyle = "#56fc03";
                                    ctx.strokeStyle="#56fc03";
                                    if(j<4){
                                        ctx.moveTo(start+(j-1)*7*xDim+(x*xDim)+(xDim/2),20+((5-y)*yDim)+(yDim/2))
                                        ctx.arc(start+(j-1)*7*xDim+(x*xDim)+(xDim/2),20+((5-y)*yDim)+(yDim/2),4,0,2*Math.PI)
                                        
                                    }
                                    else{
                                        ctx.moveTo(start+(j-4)*7*xDim+(x*xDim)+(xDim/2),6*yDim+20+((5-y)*yDim)+(yDim/2))
                                        ctx.arc(start+(j-4)*7*xDim+(x*xDim)+(xDim/2),6*yDim+20+((5-y)*yDim)+(yDim/2),4,0,2*Math.PI)
                                        
                                    }
                                    ctx.fill()
                                    ctx.stroke()
                                }
                                else if(data[j][y][x] != lastData[j][y][x] || lastData.length() != 0 && data[j][y][x] == 0){
                                    if(j<4){
                                        brokenSensorLoc.push([start+(j-1)*7*xDim+(x*xDim)+(xDim/2),20+((5-y)*yDim)+(yDim/2),j,y,x])
                                    }
                                    else{
                                        brokenSensorLoc.push([start+(j-4)*7*xDim+(x*xDim)+(xDim/2),6*yDim+20+((5-y)*yDim)+(yDim/2),j,y,x])
                                    }
                                }
                            }
                        catch{
                            continue;
                        }
                    }
                }
            }
        }
        
        function update(){
            $.get("./update",function(data){
                console.log(data)
                ctx.beginPath()
                ctx.clearRect(0,0,canvas.width,canvas.height);
                for(var y = 0; y < numPinsY; y++){
                    for(var x = 0; x < numPinsX; x++){
                        ctx.moveTo(pad+x*xDim,pad+y*yDim)
                        ctx.arc(pad+x*xDim,pad+y*yDim,2,0,2*Math.PI)
                    }
                }
                ctx.moveTo(10,10);
                ctx.lineTo(10, 30+(numPinsY-1)*yDim);
                ctx.moveTo(10,10);
                ctx.lineTo(30+(numPinsX-1)*xDim,10);
                ctx.moveTo(10, 30+(numPinsY-1)*yDim);
                ctx.lineTo(30+(numPinsX-1)*xDim,30+(numPinsY-1)*yDim);
                ctx.moveTo(30+(numPinsX-1)*xDim,10);
                ctx.lineTo(30+(numPinsX-1)*xDim, 30+(numPinsY-1)*yDim);
                ctx.moveTo(50 + ((numPinsX/3)-1)*xDim,10);
                ctx.lineTo(50 + ((numPinsX/3)-1)*xDim,30+(numPinsY-1)*yDim)
                ctx.moveTo(30 + ((numPinsX/3)*2-1)*xDim,10);
                ctx.lineTo(30 + ((numPinsX/3)*2-1)*xDim,30+(numPinsY-1)*yDim)
                ctx.moveTo(10,40 + 6*yDim);
                ctx.lineTo(30+(numPinsX-1)*xDim, 40 + 6*yDim);
                ctx.strokeStyle = "black"
                ctx.stroke()
                draw(data,lastData,brokenSensorLoc);
                lastData = []
                lastData = [...data]
                console.log(brokenSensorLoc)
                ctx.beginPath()
                ctx.strokeStyle="red";
                ctx.fillStyle="red";
                for( var i = 0; i < brokenSensorLoc.length; i++){
                    try{
                        if(lastData[brokenSensorLoc[i][2]][brokenSensorLoc[i][3]][brokenSensorLoc[i][4]]!=1){
                            ctx.moveTo(brokenSensorLoc[i][0],brokenSensorLoc[i][1])
                            ctx.arc(brokenSensorLoc[i][0],brokenSensorLoc[i][1],4,0,2*Math.PI)           
                        }
                        else{
                            brokenSensorLoc.splice(i,1);
                        }
                    }
                    catch{
                        continue;
                    }
                }
                ctx.fill()
                ctx.stroke()
                $("#output").html(data)
            });
        }
        update();
        var inrvalId = setInterval(function(){
            update()
            
        },10000)
        
    </script>
</body>
</html>